<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link href="http://cdn.kendostatic.com/2014.1.528/styles/kendo.common.min.css" rel="stylesheet" type="text/css" />
    <link href="http://cdn.kendostatic.com/2014.1.528/styles/kendo.metro.min.css" rel="stylesheet" type="text/css" />
    <link href="http://cdn.kendostatic.com/2014.1.528/styles/kendo.dataviz.min.css" rel="stylesheet" type="text/css" />
    <link href="http://cdn.kendostatic.com/2014.1.528/styles/kendo.dataviz.metro.min.css" rel="stylesheet" type="text/css" />
    <script src="http://cdn.kendostatic.com/2014.1.528/js/jquery.min.js"></script>
    <script src="http://cdn.kendostatic.com/2014.1.528/js/kendo.all.min.js"></script>
    <script src="http://cdn.kendostatic.com/2014.1.528/js/kendo.aspnetmvc.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/chroma-js/0.5.7/chroma.min.js"></script>
    <link href="Content/Site.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div class="container-fluid">
        <!--open container-->
        <div class="row row-offcanvas row-offcanvas-left">
            <!--open row-->
            <div id="nav-section" class="col-xs-12 column">
                <!--open nav column-->
                <div class="navbar-default">
                    <button id="toggle-button" type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <h1 id="dash-logo" class="center-block">Northwind&#183;Dash</h1>
                <div class="collapse navbar-collapse" id="sidebar-nav" role="navigation">
                    <ul class="nav">
                        <li id="RegionalSalesStatus">
                            <a href="index.html">
                                <span class="icon icon-chart-column"></span>Regional Sales Status</a>
                        </li>
                        <li id="ProductsAndOrders">
                            <a href="products-orders.html">
                                <span class="icon icon-star-empty"></span>Products &amp; Orders</a>
                        </li>
                        <li id="TeamEfficiency">
                            <a href="team-efficiency.html">
                                <span class="icon icon-faves"></span>Team Efficiency</a>
                        </li>
                        <li id="About">
                            <a href="about.html">
                                <span class="icon icon-info"></span>About</a>
                        </li>
                    </ul>
                    <span id="rights">Copyright Â© 2002-2014 Telerik. All rights reserved.</span>
                </div>
            </div>
            <!--close left column-->
            <div id="main-section" class="col-xs-12 column">
                <!--open main column-->
                <div id="main-section-header" class="row">
                    <h2 id="team-efficiency" class="col-xs-3">Regional sales status</h2>
                    <div id="dateFilter" class="col-xs-9">
                        <div class="period-wrapper">
                            <label for="StartDate" class="select-period">Stats from</label>
                            <input id="StartDate" />
                            <span class="k-invalid-msg" data-for="StartDate"></span>
                        </div>
                        <div class="period-wrapper">
                            <label for="EndDate" class="select-period">To</label>
                            <input id="EndDate" />
                            <span class="k-invalid-msg" data-for="EndDate"></span>
                        </div>
                    </div>
                    <div style="clear:both;"></div>
                </div>

                <div id="regional-sales" class="main-section-content row">
                    <div id="map-wrapper" class="row">
                        <div id="map-details" class="col-xs-2">
                            <h3 class="section-header">Pick a Country to view stats</h3>
                            <h3 class="section-header">COUNTRY</h3>
                            <h2 id="countryName"></h2>
                            <h3 class="section-header">CUSTOMERS</h3>
                            <div id="countryCustomers">
                                <span></span>
                            </div>
                        </div>
                        <div id="map-container" class="col-xs-10">
                            <div id="map"></div>
                        </div>
                    </div>

                    <div id="statsContainer" class="row">
                        <div id="marketShareContainer" class="col-xs-3 stats-graph">
                            <h3 class="section-header">Market share</h3>
                            <span id="MarketShareLabel"></span>
                            <div class="sparkline-container">
                                <div id="MarketShare" style="height:100px"></div>
                                <div id="MarketShareNoData" class="overlay">
                                    <div>No data available</div>
                                </div>
                            </div>
                        </div>
                        <div id="revenueContainer" class="col-xs-3 stats-graph">
                            <h3 class="section-header">Revenue</h3>
                            <span id="RevenueLabel"></span>
                            <div class="sparkline-container">
                                <div id="Revenue" style="height:100px"></div>
                                <div id="RevenueNoData" class="overlay">
                                    <div>No data available</div>
                                </div>
                            </div>
                        </div>
                        <div id="ordersContainer" class="col-xs-3 stats-graph">
                            <h3 class="section-header">Orders</h3>
                            <span id="OrdersLabel"></span>
                            <div class="sparkline-container">
                                @(Html.Kendo().Sparkline
                                <CountryOrders_Result>() .Name("Orders") .Theme("metro") .HtmlAttributes(new { @style="height: 100px;"}) .AutoBind(false) .DataSource(ds => ds .Read(read => read.Action("CountryOrders", "RegionalSales")) ) .Series(series => { series.Column(x => x.Value).CategoryField("Date").Aggregate(ChartSeriesAggregate.Sum).Color("#1996e4").Gap(0.2); }) .CategoryAxis(axis=>axis .Date() .BaseUnit(ChartAxisBaseUnit.Months) ) )
                                    <div id="OrdersNoData" class="overlay">
                                        <div>No data available</div>
                                    </div>
                            </div>
                        </div>
                        <div id="customersContainer" class="col-xs-3 stats-graph">
                            <h3 class="section-header">Customers</h3>
                            <span id="CustomersLabel"></span>
                            <div class="sparkline-container">
                                @(Html.Kendo().Sparkline
                                <CountryCustomers_Result>() .Name("Customers") .Theme("metro") .HtmlAttributes(new { @style="height: 100px;"}) .AutoBind(false) .DataSource(ds => ds .Read(read => read.Action("CountryCustomers", "RegionalSales")) ) .Series(series => { series.Column(x => x.Value).CategoryField("Date").Aggregate(ChartSeriesAggregate.Sum).Color("#1996e4").Gap(0.2); }) .CategoryAxis(axis=>axis .Date() .BaseUnit(ChartAxisBaseUnit.Months) ) )
                                    <div id="CustomersNoData" class="overlay">
                                        <div>No data available</div>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div id="topProductsContainer">
                        <h3 class="section-header">Top selling products</h3>
                        @(Html.Kendo().Chart
                        <CountryTopProducts_Result>() .Name("TopSellingProducts") .Theme("metro") .AutoBind(false) .Legend(legend => legend .Visible(true) .Position(ChartLegendPosition.Top) ) .ChartArea(ch=>ch.Background("#eeeeee")) .Events(e=>e.DataBound("onTopProductsDataBound")) .ChartArea(ch => ch.Background("#eeeeee")) .DataSource(ds => ds .Group(g => g.Add(f => f.ProductName)) .Read(read => read.Action("TopSellingProducts", "RegionalSales"))) .Series(series => { series.Line(model => model.Quantity).Style(ChartLineStyle.Smooth).Markers(false); }) .HtmlAttributes(new { @style="height: 260px;"}) .CategoryAxis(axis => axis .Categories(model => model.Date) .MajorGridLines(m => m.Visible(false)) .Line(l => l.Width(0)) .Labels(l => l.Visible(false)) ) .ValueAxis(axis => axis.Numeric() .MajorUnit(50) .MajorTicks(x => x.Visible(false)) .MajorGridLines(m => m.Visible(false)) .Line(l => l.Visible(false)) .Labels(l => l.Visible(false)) ) .Tooltip(tooltip => tooltip .Visible(true) .Template("#=data.series.name.replace(data.series.field, data.value)#")) )
                            <div id="ProductsNoData" class="overlay">
                                <div>No data available</div>
                            </div>
                    </div>
                </div>
            </div>
            <!--close main column-->
        </div>
        <!--close row-->
    </div>
    <!--close container-->

    <script>
        $(document).ready(function() {
            var scale = chroma.scale(["#ade1fb", "#097dc6"]).domain([1, 100]),
                selectedShape = null,
                selectedCountry = "USA";

            function resizeMap() {
                var map = $("#map").data("kendoMap");
                map.resize();
                map.center([50.000, 0]);
            }

            function onMarketShareDataBound(e) {
                var percentage = 0,
                    revenue = 0;
                if (this.dataSource.data().length == 2) {
                    percentage = (this.dataSource.at(1).Sales / this.dataSource.at(0).Sales);
                    revenue = this.dataSource.at(1).Sales;
                }

                $("#MarketShareLabel").text(kendo.toString(percentage, "p2"));
                $("#RevenueLabel").text(kendo.toString(revenue, "c2"));

                $("#RevenueNoData").toggle(revenue === 0);
                $("#MarketShareNoData").toggle(percentage === 0);
                if (percentage === 0) {
                    $("#MarketShare").css({
                        visibility: "hidden"
                    });
                } else {
                    $("#MarketShare").css({
                        visibility: "visible"
                    });
                }
            }

            $('[data-toggle=offcanvas]').click(function() {
                $('.row-offcanvas').toggleClass('active');
            });

            $('#EndDate').kendoDatePicker({
                value: new Date(1998, 7, 1),
                change: onCriteriaChange
            })

            $('#StartDate').kendoDatePicker({
                value: new Date(1996, 0, 1),
                change: onCriteriaChange
            })

            $("#map").kendoMap({
                center: [50.000, 0],
                zoom: 2,
                layers: [{
                    style: {
                        fill: {
                            color: "#1996E4"
                        },
                        stroke: {
                            color: "#FFFFFF"
                        }
                    },
                    type: "shape",
                    dataSource: {
                        type: "geojson",
                        transport: {
                            read: {
                                url: "http://knnikolov/tests/kendoui-northwind-dashboard/html/Content/countries-sales.geo.json"
                            }
                        }
                    }
                }],
                shapeCreated: onShapeCreated,
                shapeMouseEnter: onShapeMouseEnter,
                shapeMouseLeave: onShapeMouseLeave,
                shapeClick: onShapeClick,
                zoomable: false
            })

            $("#MarketShare").kendoChart({
                theme: "metro",
                dataBound: onMarketShareDataBound,
                legend: {
                    visible: false
                },
                dataSource: {
                    transport: {
                        read: {
                            dataType: "json",
                            url: "http://knnikolov/northwind/api/sales/GetMarketShare"
                        }
                    }
                },
                seriesDefaults: {
                    type: "donut"
                },
                series: [{
                    field: "Sales",
                    categoryField: "Country",
                }],
                tooltip: {
                    visible: true,
                    template: "#= dataItem.Country #: #= kendo.toString(dataItem.Sales, 'c2') #"
                }
            })

            $("#Revenue").kendoSparkline({
                theme: "metro",
                type: "column",
                dataSource: {
                    transport: {
                        read: {
                            url: "http://knnikolov/northwind/api/sales/GetCountryRevenue"
                        }
                    }
                },
                series: [{
                    categoryField: "Date",
                    aggregate: "sum",
                    color: "#1996e4",
                    gap: 0.2,
                    field: "Value"
                }],
                categoryAxis: {
                    type: "date",
                    baseUnit: "months"
                },
                valueAxis: {
                    crosshair: {
                        visible: false
                    }
                },
                tooltip: {
                    template: "#=kendo.toString(value, 'c2')# "
                }
            })

            function onCriteriaChange() {
                var MarketShare = $("#MarketShare").data("kendoChart"),
                    TopSellingProducts = $("#TopSellingProducts").data("kendoChart"),
                    Revenue = $("#Revenue").data("kendoSparkline"),
                    Orders = $("#Orders").data("kendoSparkline"),
                    Customers = $("#Customers").data("kendoSparkline"),
                    fromDate = $("#StartDate").data("kendoDatePicker").value(),
                    toDate = $("#EndDate").data("kendoDatePicker").value();

                /*$.ajax({
                    url: "@Url.Action("
                    CountryOrdersTotal ", "
                    RegionalSales ")",
                    dataType: "json",
                    data: {
                        Country: selectedCountry,
                        FromDate: fromDate.toJSON(),
                        ToDate: toDate.toJSON()
                    },
                    type: "POST",
                    success: function(response) {
                        $("#OrdersLabel").text(response.Orders);
                        $("#OrdersNoData").toggle(response.Orders === 0);
                    }
                });

                $.ajax({
                    url: "@Url.Action("
                    CountryCustomersTotal ", "
                    RegionalSales ")",
                    dataType: "json",
                    data: {
                        Country: selectedCountry,
                        FromDate: fromDate.toJSON(),
                        ToDate: toDate.toJSON()
                    },
                    type: "POST",
                    success: function(response) {
                        $("#CustomersLabel").text(response.Customers);
                        $("#CustomersNoData").toggle(response.Customers[0] === 0);
                    }
                });*/
                debugger;
                MarketShare.dataSource.read({
                    Country: selectedCountry,
                    FromDate: kendo.format("{0:dd/MM/yyyy hh:mm:ss}", fromDate),
                    ToDate: toDate
                });
                /*TopSellingProducts.dataSource.read({
                    Country: selectedCountry,
                    FromDate: fromDate,
                    ToDate: toDate
                });*/
                Revenue.dataSource.read({
                    Country: selectedCountry,
                    FromDate: fromDate,
                    ToDate: toDate
                });
                /*Orders.dataSource.read({
                    Country: selectedCountry,
                    FromDate: fromDate,
                    ToDate: toDate
                });
                Customers.dataSource.read({
                    Country: selectedCountry,
                    FromDate: fromDate,
                    ToDate: toDate
                });    

                ListCustomers(selectedCountry);*/

                setSparkLinesWidths();
            }

            function setSparkLinesWidths() {
                var containerWidth = $(".sparkline-container").parent().width(),
                    getSparkLines = $(".k-sparkline"),
                    sparkLineWidth = (80 * containerWidth) / 100;

                getSparkLines.each(function() {
                    $(this).data("kendoSparkline").setOptions({
                        chartArea: {
                            width: sparkLineWidth
                        }
                    });
                });

               // $("#TopSellingProducts").data("kendoChart").resize();
                $("#MarketShare").data("kendoChart").resize();
            }

            function onShapeCreated(e) {
                var color = scale(e.shape.dataItem.properties.sales).hex();
                e.shape.fill(color);
            }

            function onShapeClick(e) {
                if (selectedShape) {
                    var sales = selectedShape.dataItem.properties.sales;
                    var color = scale(sales).hex();
                    selectedShape.options.set("fill.color", color);
                    selectedShape.options.set("stroke.color", "white");
                    selectedShape.dataItem.properties.selected = false;
                }

                e.shape.options.set("fill.color", "#0c669f");
                e.shape.options.set("stroke.color", "black");
                e.shape.dataItem.properties.selected = true;
                selectedShape = e.shape;
                selectedCountry = selectedShape.dataItem.properties.name;

                onCriteriaChange();
            }

            function onShapeMouseEnter(e) {
                e.shape.options.set("fill.color", "#0c669f");
            }

            function onShapeMouseLeave(e) {
                if (!e.shape.dataItem.properties.selected) {
                    var sales = e.shape.dataItem.properties.sales;
                    var color = scale(sales).hex();
                    e.shape.options.set("fill.color", color);
                    e.shape.options.set("stroke.color", "white");
                }
            }
            $(window).resize(resizeMap);
        });
    </script>
</body>

</html>
